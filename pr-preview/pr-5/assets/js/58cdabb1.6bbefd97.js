"use strict";(self.webpackChunkuppy_io=self.webpackChunkuppy_io||[]).push([[7421],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return u}});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(n),u=o,h=c["".concat(s,".").concat(u)]||c[u]||m[u]||i;return n?a.createElement(h,r(r({ref:t},d),{},{components:n})):a.createElement(h,r({ref:t},d))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var p=2;p<i;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},4918:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return s},default:function(){return u},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return m}});var a=n(7462),o=n(3366),i=(n(7294),n(3905)),r=["components"],l={sidebar_position:4},s="Companion",p={unversionedId:"companion",id:"companion",title:"Companion",description:"Companion is a hosted, standalone, or middleware server to take away the complexity of authentication",source:"@site/docs/companion.md",sourceDirName:".",slug:"/companion",permalink:"/docs/companion",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/companion.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Uppy core library",permalink:"/docs/uppy-core"},next:{title:"Dashboard",permalink:"/docs/user-interfaces/dashboard"}},d={},m=[{value:"When should I use it?",id:"when-should-i-use-it",level:2},{value:"Hosted",id:"hosted",level:2},{value:"Installation",id:"installation",level:2},{value:"Use",id:"use",level:2},{value:"Express middleware",id:"express-middleware",level:3},{value:"Standalone",id:"standalone",level:3},{value:"API",id:"api",level:2},{value:"Options",id:"options",level:3},{value:"<code>filePath</code> <code>COMPANION_DATADIR</code>",id:"filepath-companion_datadir",level:4},{value:"<code>secret</code> <code>COMPANION_SECRET</code>",id:"secret-companion_secret",level:4},{value:"<code>uploadUrls</code> <code>COMPANION_UPLOAD_URLS</code>",id:"uploadurls-companion_upload_urls",level:4},{value:"<code>COMPANION_PORT</code>",id:"companion_port",level:4},{value:"<code>redisUrl</code> <code>COMPANION_REDIS_URL</code>",id:"redisurl-companion_redis_url",level:4},{value:"<code>redisOptions</code>",id:"redisoptions",level:4},{value:"<code>redisPubSubScope</code>",id:"redispubsubscope",level:4},{value:"<code>server</code>",id:"server",level:4},{value:"<code>sendSelfEndpoint</code> <code>COMPANION_SELF_ENDPOINT</code>",id:"sendselfendpoint-companion_self_endpoint",level:4},{value:"<code>providerOptions</code>",id:"provideroptions",level:4},{value:"<code>providerOptions.s3</code>",id:"provideroptionss3",level:4},{value:"<code>s3.key</code> <code>COMPANION_AWS_KEY</code>",id:"s3key-companion_aws_key",level:5},{value:"<code>s3.secret</code> <code>COMPANION_AWS_SECRET</code>",id:"s3secret-companion_aws_secret",level:5},{value:"<code>s3.bucket</code> <code>COMPANION_AWS_BUCKET</code>",id:"s3bucket-companion_aws_bucket",level:5},{value:"<code>s3.region</code> <code>COMPANION_AWS_REGION</code>",id:"s3region-companion_aws_region",level:5},{value:"<code>s3.awsClientOptions</code>",id:"s3awsclientoptions",level:5},{value:"<code>s3.getKey(req, filename, metadata)</code>",id:"s3getkeyreq-filename-metadata",level:5},{value:"<code>COMPANION_AWS_SECRET_FILE</code>",id:"companion_aws_secret_file",level:4},{value:"<code>COMPANION_AWS_USE_ACCELERATE_ENDPOINT</code>",id:"companion_aws_use_accelerate_endpoint",level:4},{value:"<code>COMPANION_AWS_EXPIRES</code>",id:"companion_aws_expires",level:4},{value:"<code>COMPANION_AWS_ACL</code>",id:"companion_aws_acl",level:4},{value:"<code>customProviders</code>",id:"customproviders",level:4},{value:"<code>debug</code> <code>COMPANION_DEBUG</code>",id:"debug-companion_debug",level:4},{value:"<code>logClientVersion</code>",id:"logclientversion",level:4},{value:"<code>metrics</code> <code>COMPANION_HIDE_METRICS</code>",id:"metrics-companion_hide_metrics",level:4},{value:"<code>streamingUpload</code> <code>COMPANION_STREAMING_UPLOAD</code>",id:"streamingupload-companion_streaming_upload",level:4},{value:"<code>maxFileSize</code> <code>COMPANION_MAX_FILE_SIZE</code>",id:"maxfilesize-companion_max_file_size",level:4},{value:"<code>periodicPingUrls</code> <code>COMPANION_PERIODIC_PING_URLS</code>",id:"periodicpingurls-companion_periodic_ping_urls",level:4},{value:"<code>periodicPingInterval</code> <code>COMPANION_PERIODIC_PING_INTERVAL</code>",id:"periodicpinginterval-companion_periodic_ping_interval",level:4},{value:"<code>periodicPingStaticPayload</code> <code>COMPANION_PERIODIC_PING_STATIC_JSON_PAYLOAD</code>",id:"periodicpingstaticpayload-companion_periodic_ping_static_json_payload",level:4},{value:"<code>allowLocalUrls</code> <code>COMPANION_ALLOW_LOCAL_URLS</code>",id:"allowlocalurls-companion_allow_local_urls",level:4},{value:"<code>corsOrigins</code> <code>COMPANION_CLIENT_ORIGINS</code>",id:"corsorigins-companion_client_origins",level:4},{value:"<code>COMPANION_SECRET_FILE</code>",id:"companion_secret_file",level:4},{value:"<code>COMPANION_HIDE_WELCOME</code>",id:"companion_hide_welcome",level:4},{value:"<code>COMPANION_CLIENT_ORIGINS_REGEX</code>",id:"companion_client_origins_regex",level:4},{value:"<code>COMPANION_CHUNK_SIZE</code>",id:"companion_chunk_size",level:4},{value:"Events",id:"events",level:3},{value:"Frequently asked questions",id:"frequently-asked-questions",level:2},{value:"Do you have a live example?",id:"do-you-have-a-live-example",level:3},{value:"How does the Authentication and Token mechanism work?",id:"how-does-the-authentication-and-token-mechanism-work",level:3},{value:"How to use provider redirect URIs?",id:"how-to-use-provider-redirect-uris",level:3},{value:"How to scale Companion?",id:"how-to-scale-companion",level:3},{value:"How to use Companion with Kubernetes?",id:"how-to-use-companion-with-kubernetes",level:3},{value:"How to add custom providers?",id:"how-to-add-custom-providers",level:3},{value:"list data",id:"list-data",level:4},{value:"How to run Companion locally?",id:"how-to-run-companion-locally",level:3}],c={toc:m};function u(e){var t=e.components,n=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"companion"},"Companion"),(0,i.kt)("p",null,"Companion is a hosted, standalone, or middleware server to ",(0,i.kt)("strong",{parentName:"p"},"take away the complexity of authentication\nand the cost of downloading files from remote sources"),", such as Instagram, Google Drive, and others.\nClients request remote files from Companion, which it will download and simultaneously upload to your Tus server,\nAWS bucket, or any server that supports multipart.\nCompanion is a server-to-server orchestrator, the files are not stored in Companion."),(0,i.kt)("p",null,"This means a 5GB video isn\u2019t eating into your users\u2019 data plans and you don\u2019t have to worry about OAuth."),(0,i.kt)("h2",{id:"when-should-i-use-it"},"When should I use it?"),(0,i.kt)("p",null,"If you want to let users download files from ",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/box"},"Box"),", ",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/dropbox"},"Dropbox"),", ",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/facebook"},"Facebook"),", ",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/google-drive"},"Google Drive"),", ",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/instagram"},"Instagram"),",\n",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/onedrive"},"OneDrive"),", ",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/unsplash"},"Unsplash"),", ",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/url"},"Import from URL"),", or ",(0,i.kt)("a",{parentName:"p",href:"/docs/sources/companion-plugins/zoom"},"Zoom")," \u2014 you need Companion."),(0,i.kt)("p",null,"Companion supports the same ",(0,i.kt)("a",{parentName:"p",href:"/docs/guides/choosing-upload-strategy"},"uploaders")," as Uppy:\nTus, AWS S3, and regular multipart. But instead of a plugin you configure which one to use with ",(0,i.kt)("a",{parentName:"p",href:"#options"},(0,i.kt)("inlineCode",{parentName:"a"},"protocol")),".\nThis means if you are using ",(0,i.kt)("a",{parentName:"p",href:"/docs/uploaders/tus"},"Tus")," for your local uploads, you can send your remote uploads\nto the same Tus server (and likewise for AWS S3)."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Companion only deals with ",(0,i.kt)("em",{parentName:"p"},"remote")," files, ",(0,i.kt)("em",{parentName:"p"},"local")," files are still uploaded from the client\nwith your upload plugin."))),(0,i.kt)("h2",{id:"hosted"},"Hosted"),(0,i.kt)("p",null,"Using ",(0,i.kt)("a",{parentName:"p",href:"https://transloadit.com"},"Transloadit")," services comes with a hosted version of Companion so you don\u2019t have to worry about hosting your own server.\nWhether you are on a free or paid Transloadit ",(0,i.kt)("a",{parentName:"p",href:"https://transloadit.com/pricing/"},"plan"),", you can use Companion.\nIt\u2019s not possible to rent a Companion server without a Transloadit plan."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Choosing Transloadit for your file services also comes with credentials for all remote providers.\nThis means you don\u2019t have to waste time going through the approval process of every app.\nHowever you can still add your own credentials in the Transloadit admin page if you want. "))),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Downloading and uploading files through Companion doesn\u2019t count towards\nyour ",(0,i.kt)("a",{parentName:"p",href:"https://transloadit.com/docs/faq/1gb-worth/"},"monthly quota"),",\nit\u2019s a way for files to arrive at Transloadit servers, much like Uppy."))),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://transloadit.com/pricing/"},(0,i.kt)("strong",{parentName:"a"},"Sign-up for a (free) plan")),"."),(0,i.kt)("h2",{id:"installation"},"Installation"),(0,i.kt)("p",null,"If you want to host your own Companion server start by installing it:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm install @uppy/companion\n")),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Since v2, you need to be running ",(0,i.kt)("inlineCode",{parentName:"p"},"node.js >= v10.20.1")," to use Companion.\nMore information in the ",(0,i.kt)("a",{parentName:"p",href:"/docs/guides/migrate-2.0"},"migrating to 2.0")," guide."),(0,i.kt)("p",{parentName:"div"},"Windows is not a supported platform right now.\nIt may work, and we\u2019re happy to accept improvements in this area, but we can\u2019t provide support."))),(0,i.kt)("h2",{id:"use"},"Use"),(0,i.kt)("p",null,"Companion can be integrated as middleware into your ",(0,i.kt)("a",{parentName:"p",href:"https://expressjs.com/"},"Express")," app or as a standalone server."),(0,i.kt)("h3",{id:"express-middleware"},"Express middleware"),(0,i.kt)("p",null,"To plug Companion into an existing server, call its ",(0,i.kt)("inlineCode",{parentName:"p"},".app")," method,\npassing in an ",(0,i.kt)("a",{parentName:"p",href:"#Options"},"options")," object as a parameter.\nThis returns a server instance that you can mount on a route in your Express app."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"import express from 'express'\nimport bodyParser from 'body-parser'\nimport session from 'express-session'\nimport companion from '@uppy/companion'\n\nconst app = express()\n\n// Companion requires body-parser and express-session middleware.\n// You can add it like this if you use those throughout your app.\n//\n// If you are using something else in your app, you can add these\n// middlewares in the same subpath as Companion instead.\napp.use(bodyParser.json())\napp.use(session({ secret: 'some secrety secret' }))\n\nconst options = {\n  providerOptions: {\n    drive: {\n      key: 'GOOGLE_DRIVE_KEY',\n      secret: 'GOOGLE_DRIVE_SECRET',\n    },\n  },\n  server: {\n    host: 'localhost:3020',\n    protocol: 'http',\n    // This MUST match the path you specify in `app.use()` below:\n    path: '/companion',\n  },\n  filePath: '/path/to/folder/',\n}\n\napp.use('/companion', companion.app(options))\n")),(0,i.kt)("p",null,"Companion uses WebSockets to communicate progress, errors, and successes to the client.\nThis is what Uppy listens to to update it\u2019s internal state and UI, if there is one."),(0,i.kt)("p",null,"Add the Companion WebSocket server using the ",(0,i.kt)("inlineCode",{parentName:"p"},"companion.socket")," function:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const server = app.listen(PORT)\n\ncompanion.socket(server)\n")),(0,i.kt)("p",null,"If WebSockets fail for some reason Uppy and Companion will fallback to HTTP polling."),(0,i.kt)("h3",{id:"standalone"},"Standalone"),(0,i.kt)("p",null,"You can use the standalone version if you want to run Companion as it\u2019s own Node process.\nThe standalone version is a configured Express server with sessions, logging, and security best practices."),(0,i.kt)("p",null,"Companion ships with an excecutable file (",(0,i.kt)("inlineCode",{parentName:"p"},"bin/companion"),") which is the standalone server.\nUnlike the middleware version, options are set via environment variables."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Checkout ",(0,i.kt)("a",{parentName:"p",href:"#options"},"options")," for the available options in JS and environment variable formats."))),(0,i.kt)("p",null,"You need at least these three to get started:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'export COMPANION_SECRET="shh!Issa Secret!"\nexport COMPANION_DOMAIN="YOUR SERVER DOMAIN"\nexport COMPANION_DATADIR="PATH/TO/DOWNLOAD/DIRECTORY"\n')),(0,i.kt)("p",null,"Then run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"companion\n")),(0,i.kt)("p",null,"You can also pass in the path to your JSON config file, like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"companion --config /path/to/companion.json\n")),(0,i.kt)("h2",{id:"api"},"API"),(0,i.kt)("h3",{id:"options"},"Options"),(0,i.kt)("details",null,(0,i.kt)("summary",null,"Example configuration"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"const options = {\n  providerOptions: {\n    drive: {\n      key: '***',\n      secret: '***',\n    },\n    dropbox: {\n      key: '***',\n      secret: '***',\n    },\n    instagram: {\n      key: '***',\n      secret: '***',\n    },\n    facebook: {\n      key: '***',\n      secret: '***',\n    },\n    onedrive: {\n      key: '***',\n      secret: '***',\n    },\n    s3: {\n      getKey: (req, filename, metadata) => filename,\n      key: '***',\n      secret: '***',\n      bucket: 'bucket-name',\n      region: 'us-east-1',\n      useAccelerateEndpoint: false, // default: false,\n      expires: 3600, // default: 300 (5 minutes)\n      acl: 'private', // default: public-read\n    },\n  },\n  server: {\n    host: 'localhost:3020', // or yourdomain.com\n    protocol: 'http',\n  },\n  filePath: 'path/to/download/folder',\n  sendSelfEndpoint: 'localhost:3020',\n  secret: 'mysecret',\n  uploadUrls: ['https://myuploadurl.com', /^http:\\/\\/myuploadurl2.com\\//],\n  debug: true,\n  metrics: false,\n  streamingUpload: true,\n  allowLocalUrls: false,\n  maxFileSize: 100000000,\n  periodicPingUrls: [],\n  periodicPingInterval: 60000,\n  periodicPingStaticPayload: { static: 'payload' },\n  corsOrigins: true,\n}\n"))),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The headings display the JS and environment variable options (",(0,i.kt)("inlineCode",{parentName:"p"},"option")," ",(0,i.kt)("inlineCode",{parentName:"p"},"ENV_OPTION"),").\nWhen integrating Companion into your own server, you pass the options to ",(0,i.kt)("inlineCode",{parentName:"p"},"companion.app()"),".\nIf you are using the standalone version, you configure Companion using environment variables."))),(0,i.kt)("h4",{id:"filepath-companion_datadir"},(0,i.kt)("inlineCode",{parentName:"h4"},"filePath")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_DATADIR")),(0,i.kt)("p",null,"Full path to the directory to which provider files will be downloaded temporarily."),(0,i.kt)("h4",{id:"secret-companion_secret"},(0,i.kt)("inlineCode",{parentName:"h4"},"secret")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_SECRET")),(0,i.kt)("p",null,"A secret string which Companion uses to generate authorization tokens.\nYou should generate a long random string for this. For example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const crypto = require('crypto')\n\nconst secret = crypto.randomBytes(64).toString('hex')\n")),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Omitting the ",(0,i.kt)("inlineCode",{parentName:"p"},"secret")," in the standalone version will generate a secret for you,\nusing the above ",(0,i.kt)("inlineCode",{parentName:"p"},"crypto")," string. But when integrating with Express you must provide it yourself.\nThis is an essential security measure."))),(0,i.kt)("h4",{id:"uploadurls-companion_upload_urls"},(0,i.kt)("inlineCode",{parentName:"h4"},"uploadUrls")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_UPLOAD_URLS")),(0,i.kt)("p",null,"An allowlist (array) of strings (exact URLs) or regular expressions.\nIf specified, Companion will only accept uploads to these URLs.\nThis is needed to make sure a Companion instance is only allowed to upload to your servers."),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Omitting this leaves your system open to potential ",(0,i.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Server-side_request_forgery"},"SSRF")," attacks,\nand may throw an error in future ",(0,i.kt)("inlineCode",{parentName:"p"},"@uppy/companion")," releases."))),(0,i.kt)("h4",{id:"companion_port"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_PORT")),(0,i.kt)("p",null,"The port on which to start the standalone server, defaults to 3020."),(0,i.kt)("h4",{id:"redisurl-companion_redis_url"},(0,i.kt)("inlineCode",{parentName:"h4"},"redisUrl")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_REDIS_URL")),(0,i.kt)("p",null,"TODO: needs a great explanation if it actually works, so let's figure out if it works"),(0,i.kt)("p",null,"URL to running Redis server.\nIf this is set, the state of uploads would be stored temporarily.\nThis helps for resumed uploads after a browser crash from the client.\nThe stored upload would be sent back to the client on reconnection."),(0,i.kt)("h4",{id:"redisoptions"},(0,i.kt)("inlineCode",{parentName:"h4"},"redisOptions")),(0,i.kt)("p",null,"An object of ",(0,i.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/redis#options-object-properties"},"options supported by redis client"),".\nThis option can be used in place of ",(0,i.kt)("inlineCode",{parentName:"p"},"redisUrl"),"."),(0,i.kt)("h4",{id:"redispubsubscope"},(0,i.kt)("inlineCode",{parentName:"h4"},"redisPubSubScope")),(0,i.kt)("p",null,"Use a scope for the companion events at the Redis server.\nSetting this option will prefix all events with the name provided and a colon."),(0,i.kt)("h4",{id:"server"},(0,i.kt)("inlineCode",{parentName:"h4"},"server")),(0,i.kt)("p",null,"Configuation options for the underlying server."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Key / Env var"),(0,i.kt)("th",{parentName:"tr",align:null},"Value"),(0,i.kt)("th",{parentName:"tr",align:null},"Description"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"protocol")," ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_PROTOCOL")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"http")," or ",(0,i.kt)("inlineCode",{parentName:"td"},"https")),(0,i.kt)("td",{parentName:"tr",align:null},"Used to build a URL to reference the Companion instance itself, which is used for headers and cookies. Companion does not serve SSL certificates, so by default you should use ",(0,i.kt)("inlineCode",{parentName:"td"},"http"),". You want to set this to ",(0,i.kt)("inlineCode",{parentName:"td"},"https")," if you\u2019ve enabled SSL/HTTPS for your domain by running a reverse https-proxy in front of Companion, or with a built-in HTTPS feature of your hosting service, such as Heroku.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"host")," ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_DOMAIN")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"String")),(0,i.kt)("td",{parentName:"tr",align:null},"Your server\u2019s publically facing hostname (for example ",(0,i.kt)("inlineCode",{parentName:"td"},"example.com"),").")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"oauthDomain")," ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_OAUTH_DOMAIN")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"String")),(0,i.kt)("td",{parentName:"tr",align:null},"If you have several instances of Companion with different (and perhaps dynamic) subdomains, you can set a single fixed subdomain and server (such as ",(0,i.kt)("inlineCode",{parentName:"td"},"sub1.example.com"),") to handle your OAuth authentication for you. This would then redirect back to the correct instance with the required credentials on completion. This way you only need to configure a single callback URL for OAuth providers.")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"path")," ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_PATH")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"String")),(0,i.kt)("td",{parentName:"tr",align:null},"The server path to where the Companion app is sitting. For instance, if Companion is at ",(0,i.kt)("inlineCode",{parentName:"td"},"example.com/companion"),", then the path would be ",(0,i.kt)("inlineCode",{parentName:"td"},"/companion"),").")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"implicitPath")," ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_IMPLICIT_PATH")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"String")),(0,i.kt)("td",{parentName:"tr",align:null},"If the URL\u2019s path in your reverse proxy is different from your Companion path in your express app, then you need to set this path as ",(0,i.kt)("inlineCode",{parentName:"td"},"implicitPath"),". For instance, if your Companion URL is ",(0,i.kt)("inlineCode",{parentName:"td"},"example.com/mypath/companion"),". Where the path ",(0,i.kt)("inlineCode",{parentName:"td"},"/mypath")," is defined in your NGINX server, while ",(0,i.kt)("inlineCode",{parentName:"td"},"/companion")," is set in your express app. Then you need to set the option ",(0,i.kt)("inlineCode",{parentName:"td"},"implicitPath")," to ",(0,i.kt)("inlineCode",{parentName:"td"},"/mypath"),", and set the ",(0,i.kt)("inlineCode",{parentName:"td"},"path")," option to ",(0,i.kt)("inlineCode",{parentName:"td"},"/companion"),".")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"validHosts")," ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_DOMAINS")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"Array")),(0,i.kt)("td",{parentName:"tr",align:null},"If you are setting an ",(0,i.kt)("inlineCode",{parentName:"td"},"oauthDomain"),", you need to set a list of valid hosts, so the oauth handler can validate the host of the Uppy instance requesting the authentication. This is essentially a list of valid domains running your Companion instances. The list may also contain regex patterns. e.g ",(0,i.kt)("inlineCode",{parentName:"td"},"['sub2.example.com', 'sub3.example.com', '(\\\\w+).example.com']"))))),(0,i.kt)("h4",{id:"sendselfendpoint-companion_self_endpoint"},(0,i.kt)("inlineCode",{parentName:"h4"},"sendSelfEndpoint")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_SELF_ENDPOINT")),(0,i.kt)("p",null,"This is essentially the same as the ",(0,i.kt)("inlineCode",{parentName:"p"},"server.host + server.path")," attributes.\nThe major reason for this attribute is that, when set, it adds the value as the ",(0,i.kt)("inlineCode",{parentName:"p"},"i-am")," header of every request response."),(0,i.kt)("h4",{id:"provideroptions"},(0,i.kt)("inlineCode",{parentName:"h4"},"providerOptions")),(0,i.kt)("p",null,"Object to enable providers with their keys and secrets. For example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"providerOptions: {\n  drive: {\n    key: '***',\n    secret: '***',\n  },\n}\n")),(0,i.kt)("p",null,"When using the standalone version you use the corresponding environment variables\nor point to a secret file (such as ",(0,i.kt)("inlineCode",{parentName:"p"},"COMPANION_GOOGLE_SECRET_FILE"),")."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Service"),(0,i.kt)("th",{parentName:"tr",align:null},"Key"),(0,i.kt)("th",{parentName:"tr",align:null},"Environment variables"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Box"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"box")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_BOX_KEY"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_BOX_SECRET"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_BOX_SECRET_FILE"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Dropbox"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"dropbox")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_DROPBOX_KEY"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_DROPBOX_SECRET"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_DROPBOX_SECRET_FILE"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Facebook"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"facebook")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_FACEBOOK_KEY"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_FACEBOOK_SECRET"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_FACEBOOK_SECRET_FILE"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Google Drive"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"drive")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_GOOGLE_KEY"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_GOOGLE_SECRET"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_GOOGLE_SECRET_FILE"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Instagram"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"instagram")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_INSTAGRAM_KEY"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_INSTAGRAM_SECRET"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_INSTAGRAM_SECRET_FILE"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"OneDrive"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"onedrive")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_ONEDRIVE_KEY"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_ONEDRIVE_SECRET"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_ONEDRIVE_SECRET_FILE"))),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Zoom"),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"zoom")),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_ZOOM_KEY"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_ZOOM_SECRET"),", ",(0,i.kt)("inlineCode",{parentName:"td"},"COMPANION_ZOOM_SECRET_FILE"))))),(0,i.kt)("h4",{id:"provideroptionss3"},(0,i.kt)("inlineCode",{parentName:"h4"},"providerOptions.s3")),(0,i.kt)("p",null,"Companion comes with signature endpoints for AWS S3.\nThese can be used by the Uppy client to sign requests to upload files directly to S3, without exposing secret S3 keys in the browser.\nCompanion also supports uploading files from providers like Dropbox and Instagram directly into S3."),(0,i.kt)("h5",{id:"s3key-companion_aws_key"},(0,i.kt)("inlineCode",{parentName:"h5"},"s3.key")," ",(0,i.kt)("inlineCode",{parentName:"h5"},"COMPANION_AWS_KEY")),(0,i.kt)("p",null,"The S3 access key ID."),(0,i.kt)("h5",{id:"s3secret-companion_aws_secret"},(0,i.kt)("inlineCode",{parentName:"h5"},"s3.secret")," ",(0,i.kt)("inlineCode",{parentName:"h5"},"COMPANION_AWS_SECRET")),(0,i.kt)("p",null,"The S3 secret access key."),(0,i.kt)("h5",{id:"s3bucket-companion_aws_bucket"},(0,i.kt)("inlineCode",{parentName:"h5"},"s3.bucket")," ",(0,i.kt)("inlineCode",{parentName:"h5"},"COMPANION_AWS_BUCKET")),(0,i.kt)("p",null,"The name of the bucket to store uploaded files in."),(0,i.kt)("h5",{id:"s3region-companion_aws_region"},(0,i.kt)("inlineCode",{parentName:"h5"},"s3.region")," ",(0,i.kt)("inlineCode",{parentName:"h5"},"COMPANION_AWS_REGION")),(0,i.kt)("p",null,"The datacenter region where the target bucket is located."),(0,i.kt)("h5",{id:"s3awsclientoptions"},(0,i.kt)("inlineCode",{parentName:"h5"},"s3.awsClientOptions")),(0,i.kt)("p",null,"You can supply any ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#constructor-property"},"S3 option supported by the AWS SDK"),"\nin the ",(0,i.kt)("inlineCode",{parentName:"p"},"providerOptions.s3.awsClientOptions")," object, ",(0,i.kt)("em",{parentName:"p"},"except for")," the below:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"accessKeyId"),". Instead, use the ",(0,i.kt)("inlineCode",{parentName:"li"},"providerOptions.s3.key")," property.\nThis is to make configuration names consistent between different Companion features."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"secretAccessKey"),". Instead, use the ",(0,i.kt)("inlineCode",{parentName:"li"},"providerOptions.s3.secret")," property.\nThis is to make configuration names consistent between different Companion features.")),(0,i.kt)("p",null,"Be aware that some options may cause wrong behaviour if they conflict with Companion\u2019s assumptions.\nIf you find that a particular option does not work as expected, please ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/transloadit/uppy/issues/new"},"open an issue on the Uppy repository")," so we can document it here."),(0,i.kt)("h5",{id:"s3getkeyreq-filename-metadata"},(0,i.kt)("inlineCode",{parentName:"h5"},"s3.getKey(req, filename, metadata)")),(0,i.kt)("p",null,"Get the key name for a file. The key is the file path to which the file will be uploaded in your bucket.\nThis option should be a function receiving three arguments:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"req"),", the HTTP request, for ",(0,i.kt)("em",{parentName:"li"},"regular")," S3 uploads using the ",(0,i.kt)("inlineCode",{parentName:"li"},"@uppy/aws-s3")," plugin.\nThis parameter is ",(0,i.kt)("em",{parentName:"li"},"not")," available for multipart uploads using the ",(0,i.kt)("inlineCode",{parentName:"li"},"@uppy/aws-s3-multipart")," plugin;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"filename"),", the original name of the uploaded file;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"metadata"),", user-provided metadata for the file.\nSee the ",(0,i.kt)("a",{parentName:"li",href:"https://uppy.io/docs/aws-s3/#metaFields"},(0,i.kt)("inlineCode",{parentName:"a"},"@uppy/aws-s3"))," docs. The ",(0,i.kt)("inlineCode",{parentName:"li"},"@uppy/aws-s3-multipart")," plugin unconditionally sends all metadata fields, so they all are available here.")),(0,i.kt)("p",null,"This function should return a string ",(0,i.kt)("inlineCode",{parentName:"p"},"key"),".\nThe ",(0,i.kt)("inlineCode",{parentName:"p"},"req")," parameter can be used to upload to a user-specific folder in your bucket, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"app.use(authenticationMiddleware)\napp.use(uppy.app({\n  providerOptions: {\n    s3: {\n      getKey: (req, filename, metadata) => `${req.user.id}/${filename}`,\n      /* auth options */\n    },\n  },\n}))\n")),(0,i.kt)("p",null,"The default implementation returns the ",(0,i.kt)("inlineCode",{parentName:"p"},"filename"),",\nso all files will be uploaded to the root of the bucket as their original file name."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"app.use(uppy.app({\n  providerOptions: {\n    s3: {\n      getKey: (req, filename, metadata) => filename,\n    },\n  },\n}))\n")),(0,i.kt)("h4",{id:"companion_aws_secret_file"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_AWS_SECRET_FILE")),(0,i.kt)("p",null,"Using a secret file instead of ",(0,i.kt)("a",{parentName:"p",href:"#s3secret-companion_aws_secret"},(0,i.kt)("inlineCode",{parentName:"a"},"s3.secret")),".\nA secret file is a file that only contains the secret."),(0,i.kt)("h4",{id:"companion_aws_use_accelerate_endpoint"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_AWS_USE_ACCELERATE_ENDPOINT")),(0,i.kt)("p",null,"Enable S3 ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/transfer-acceleration.html"},"Transfer Acceleration"),"."),(0,i.kt)("h4",{id:"companion_aws_expires"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_AWS_EXPIRES")),(0,i.kt)("p",null,"Set ",(0,i.kt)("inlineCode",{parentName:"p"},"X-Amz-Expires")," query parameter in the presigned urls (in seconds, default: 300)."),(0,i.kt)("h4",{id:"companion_aws_acl"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_AWS_ACL")),(0,i.kt)("p",null,"Set a ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html#canned-acl"},"Canned ACL")," for uploaded objects."),(0,i.kt)("h4",{id:"customproviders"},(0,i.kt)("inlineCode",{parentName:"h4"},"customProviders")),(0,i.kt)("p",null,"This option enables you to add custom providers along with the already supported providers.\nSee ",(0,i.kt)("a",{parentName:"p",href:"#how-to-add-custom-providers"},"adding custom providers")," for more information."),(0,i.kt)("h4",{id:"debug-companion_debug"},(0,i.kt)("inlineCode",{parentName:"h4"},"debug")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_DEBUG")),(0,i.kt)("p",null,"A boolean flag to tell Companion whether to log useful debug information while running."),(0,i.kt)("h4",{id:"logclientversion"},(0,i.kt)("inlineCode",{parentName:"h4"},"logClientVersion")),(0,i.kt)("p",null,"A boolean flag to tell Companion whether to log its version upon startup."),(0,i.kt)("h4",{id:"metrics-companion_hide_metrics"},(0,i.kt)("inlineCode",{parentName:"h4"},"metrics")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_HIDE_METRICS")),(0,i.kt)("p",null,"A boolean flag to tell Companion whether to provide an endpoint ",(0,i.kt)("inlineCode",{parentName:"p"},"/metrics")," with Prometheus metrics."),(0,i.kt)("h4",{id:"streamingupload-companion_streaming_upload"},(0,i.kt)("inlineCode",{parentName:"h4"},"streamingUpload")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_STREAMING_UPLOAD")),(0,i.kt)("p",null,"A boolean flag to tell Companion whether to enable streaming uploads.\nIf enabled, it will lead to ",(0,i.kt)("em",{parentName:"p"},"faster uploads")," because companion will start uploading at the same time as downloading using ",(0,i.kt)("inlineCode",{parentName:"p"},"stream.pipe"),".\nIf ",(0,i.kt)("inlineCode",{parentName:"p"},"false"),", files will be fully downloaded first, then uploaded.\nDefaults to ",(0,i.kt)("inlineCode",{parentName:"p"},"false"),". "),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Do not set it to ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," if you have a ",(0,i.kt)("a",{parentName:"p",href:"#how-to-add-custom-providers"},"custom Companion provider")," that does not use the new async/stream API."))),(0,i.kt)("h4",{id:"maxfilesize-companion_max_file_size"},(0,i.kt)("inlineCode",{parentName:"h4"},"maxFileSize")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_MAX_FILE_SIZE")),(0,i.kt)("p",null,"If this value is set, companion will limit the maximum file size to process. If unset, it will process files without any size limit (this is the default)."),(0,i.kt)("h4",{id:"periodicpingurls-companion_periodic_ping_urls"},(0,i.kt)("inlineCode",{parentName:"h4"},"periodicPingUrls")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_PERIODIC_PING_URLS")),(0,i.kt)("p",null,"If this value is set, companion will periodically send POST requests to the specified URLs.\nUseful for keeping track of companion instances as a keep-alive."),(0,i.kt)("h4",{id:"periodicpinginterval-companion_periodic_ping_interval"},(0,i.kt)("inlineCode",{parentName:"h4"},"periodicPingInterval")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_PERIODIC_PING_INTERVAL")),(0,i.kt)("p",null,"Interval for periodic ping requests (in ms)."),(0,i.kt)("h4",{id:"periodicpingstaticpayload-companion_periodic_ping_static_json_payload"},(0,i.kt)("inlineCode",{parentName:"h4"},"periodicPingStaticPayload")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_PERIODIC_PING_STATIC_JSON_PAYLOAD")),(0,i.kt)("p",null,"A ",(0,i.kt)("inlineCode",{parentName:"p"},"JSON.stringify"),"-able JavaScript Object that will be sent as part of the JSON body in the period ping requests."),(0,i.kt)("h4",{id:"allowlocalurls-companion_allow_local_urls"},(0,i.kt)("inlineCode",{parentName:"h4"},"allowLocalUrls")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_ALLOW_LOCAL_URLS")),(0,i.kt)("p",null,"A boolean flag to tell Companion whether to allow requesting local URLs."),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Only enable this in development. ",(0,i.kt)("strong",{parentName:"p"},"Enabling it in production is a security risk.")))),(0,i.kt)("h4",{id:"corsorigins-companion_client_origins"},(0,i.kt)("inlineCode",{parentName:"h4"},"corsOrigins")," ",(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_CLIENT_ORIGINS")),(0,i.kt)("p",null,"Allowed CORS Origins (default ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),").\nPassed as the ",(0,i.kt)("inlineCode",{parentName:"p"},"origin")," option in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/expressjs/cors#configuration-options"},"cors"),")"),(0,i.kt)("h4",{id:"companion_secret_file"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_SECRET_FILE")),(0,i.kt)("p",null,"Specifying a secret file will override a directly set ",(0,i.kt)("a",{parentName:"p",href:"#secret"},"secret"),"."),(0,i.kt)("h4",{id:"companion_hide_welcome"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_HIDE_WELCOME")),(0,i.kt)("p",null,"Disables the welcome page."),(0,i.kt)("h4",{id:"companion_client_origins_regex"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_CLIENT_ORIGINS_REGEX")),(0,i.kt)("p",null,"Like COMPANION_CLIENT_ORIGINS, but allows a single regex instead.\n",(0,i.kt)("inlineCode",{parentName:"p"},"COMPANION_CLIENT_ORIGINS")," will be ignored if this is used."),(0,i.kt)("h4",{id:"companion_chunk_size"},(0,i.kt)("inlineCode",{parentName:"h4"},"COMPANION_CHUNK_SIZE")),(0,i.kt)("p",null,"Chunk size?"),(0,i.kt)("h3",{id:"events"},"Events"),(0,i.kt)("p",null,"The object returned by ",(0,i.kt)("inlineCode",{parentName:"p"},"companion.app()")," also has a property ",(0,i.kt)("inlineCode",{parentName:"p"},"companionEmitter")," which is an ",(0,i.kt)("inlineCode",{parentName:"p"},"EventEmitter"),"\nthat emits the following events:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"upload-start")," - When an upload starts, this event is emitted with an object containing the property ",(0,i.kt)("inlineCode",{parentName:"li"},"token"),", which is a unique ID for the upload."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"token")," - The event name is the token from ",(0,i.kt)("inlineCode",{parentName:"li"},"upload-start"),". The event has an object with the following properties:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"action")," - One of the following strings:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"success")," - When the upload succeeds."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"error")," - When the upload fails with an error."))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"payload")," - the error or success payload.")))),(0,i.kt)("p",null,"Example code for using the ",(0,i.kt)("inlineCode",{parentName:"p"},"EventEmitter")," to handle a finished file upload:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const companionApp = companion.app(options)\nconst { companionEmitter: emitter } = companionApp\n\nemitter.on('upload-start', ({ token }) => {\n  console.log('Upload started', token)\n\n  function onUploadEvent ({ action, payload }) {\n    if (action === 'success') {\n      emitter.off(token, onUploadEvent) // avoid listener leak\n      console.log('Upload finished', token, payload.url)\n    } else if (action === 'error') {\n      emitter.off(token, onUploadEvent) // avoid listener leak\n      console.error('Upload failed', payload)\n    }\n  }\n  emitter.on(token, onUploadEvent)\n})\n")),(0,i.kt)("h2",{id:"frequently-asked-questions"},"Frequently asked questions"),(0,i.kt)("h3",{id:"do-you-have-a-live-example"},"Do you have a live example?"),(0,i.kt)("p",null,"An example server is running at ",(0,i.kt)("a",{parentName:"p",href:"https://companion.uppy.io"},"https://companion.uppy.io"),", which is deployed with ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/transloadit/uppy/blob/main/packages/%40uppy/companion/KUBERNETES.md"},"Kubernetes")),(0,i.kt)("h3",{id:"how-does-the-authentication-and-token-mechanism-work"},"How does the Authentication and Token mechanism work?"),(0,i.kt)("p",null,"This section describes how Authentication works between Companion and Providers. While this behaviour is the same for all Providers (Dropbox, Instagram, Google Drive, etc.), we are going to be referring to Dropbox in place of any Provider throughout this section."),(0,i.kt)("p",null,"The following steps describe the actions that take place when a user Authenticates and Uploads from Dropbox through Companion:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The visitor to a website with Uppy clicks ",(0,i.kt)("inlineCode",{parentName:"li"},"Connect to Dropbox"),"."),(0,i.kt)("li",{parentName:"ul"},"Uppy sends a request to Companion, which in turn sends an OAuth request to Dropbox (Requires that OAuth credentials from Dropbox have been added to Companion)."),(0,i.kt)("li",{parentName:"ul"},"Dropbox asks the visitor to log in, and whether the Website should be allowed to access your files"),(0,i.kt)("li",{parentName:"ul"},"If the visitor agrees, Companion will receive a token from Dropbox, with which we can temporarily download files."),(0,i.kt)("li",{parentName:"ul"},"Companion encrypts the token with a secret key and sends the encrypted token to Uppy (client)"),(0,i.kt)("li",{parentName:"ul"},"Every time the visitor clicks on a folder in Uppy, it asks Companion for the new list of files, with this question, the token (still encrypted by Companion) is sent along."),(0,i.kt)("li",{parentName:"ul"},"Companion decrypts the token, requests the list of files from Dropbox and sends it to Uppy."),(0,i.kt)("li",{parentName:"ul"},"When a file is selected for upload, Companion receives the token again according to this procedure, decrypts it again, and thereby downloads the file from Dropbox."),(0,i.kt)("li",{parentName:"ul"},"As the bytes arrive, Companion uploads the bytes to the final destination (depending on the configuration: Apache, a Tus server, S3 bucket, etc)."),(0,i.kt)("li",{parentName:"ul"},"Companion reports progress to Uppy, as if it were a local upload."),(0,i.kt)("li",{parentName:"ul"},"Completed!")),(0,i.kt)("h3",{id:"how-to-use-provider-redirect-uris"},"How to use provider redirect URIs?"),(0,i.kt)("p",null,"When generating your provider API keys on their corresponding developer platforms (e.g ",(0,i.kt)("a",{parentName:"p",href:"https://console.developers.google.com/"},"Google Developer Console"),"), you\u2019d need to provide a ",(0,i.kt)("inlineCode",{parentName:"p"},"redirect URI")," for the OAuth authorization process. In general the redirect URI for each provider takes the format:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"http(s)://$YOUR_COMPANION_HOST_NAME/$PROVIDER_NAME/redirect")),(0,i.kt)("p",null,"For example, if your Companion server is hosted on ",(0,i.kt)("inlineCode",{parentName:"p"},"https://my.companion.server.com"),", then the redirect URI you would supply for your OneDrive provider would be:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"https://my.companion.server.com/onedrive/redirect")),(0,i.kt)("p",null,"Please see ",(0,i.kt)("a",{parentName:"p",href:"https://uppy.io/docs/companion/#Supported-providers"},"Supported Providers")," for a list of all Providers and their corresponding names."),(0,i.kt)("h3",{id:"how-to-scale-companion"},"How to scale Companion?"),(0,i.kt)("p",null,"..."),(0,i.kt)("h3",{id:"how-to-use-companion-with-kubernetes"},"How to use Companion with Kubernetes?"),(0,i.kt)("p",null,"We have ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/transloadit/uppy/blob/main/packages/%40uppy/companion/KUBERNETES.md"},"a detailed guide on running Companion in Kubernetes")," for you, that\u2019s how we run our example server at ",(0,i.kt)("a",{parentName:"p",href:"https://companion.uppy.io"},"https://companion.uppy.io"),"."),(0,i.kt)("h3",{id:"how-to-add-custom-providers"},"How to add custom providers?"),(0,i.kt)("p",null,"As of now, Companion supports the ",(0,i.kt)("a",{parentName:"p",href:"https://uppy.io/docs/companion/#Supported-providers"},"providers listed here")," out of the box, but you may also choose to add your own custom providers. You can do this by passing the ",(0,i.kt)("inlineCode",{parentName:"p"},"customProviders")," option when calling the Uppy ",(0,i.kt)("inlineCode",{parentName:"p"},"app")," method. The custom provider is expected to support Oauth 1 or 2 for authentication/authorization."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"import providerModule from './path/to/provider/module'\n\nconst options = {\n  customProviders: {\n    myprovidername: {\n      config: {\n        authorize_url: 'https://mywebsite.com/authorize',\n        access_url: 'https://mywebsite.com/token',\n        oauth: 2,\n        key: '***',\n        secret: '***',\n        scope: ['read', 'write'],\n      },\n      module: providerModule,\n    },\n  },\n}\n\nuppy.app(options)\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"customProviders")," option should be an object containing each custom provider. Each custom provider would, in turn, be an object with two keys, ",(0,i.kt)("inlineCode",{parentName:"p"},"config")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"module"),". The ",(0,i.kt)("inlineCode",{parentName:"p"},"config")," option would contain Oauth API settings, while the ",(0,i.kt)("inlineCode",{parentName:"p"},"module")," would point to the provider module."),(0,i.kt)("p",null,"To work well with Companion, the ",(0,i.kt)("strong",{parentName:"p"},"module")," must be a class with the following methods. Note that the methods must be ",(0,i.kt)("inlineCode",{parentName:"p"},"async"),", return a ",(0,i.kt)("inlineCode",{parentName:"p"},"Promise")," or reject with an ",(0,i.kt)("inlineCode",{parentName:"p"},"Error"),"):"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"async list ({ token, directory, query })")," - Returns a object containing a list of user files (such as a list of all the files in a particular directory). See ",(0,i.kt)("a",{parentName:"li",href:"#list-data"},"example returned list data structure"),".\n",(0,i.kt)("inlineCode",{parentName:"li"},"token")," - authorization token (retrieved from oauth process) to send along with your request",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"directory")," - the id/name of the directory from which data is to be retrieved. This may be ignored if it doesn\u2019t apply to your provider"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"query")," - expressjs query params object received by the server (in case some data you need in there)."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"async download ({ token, id, query })")," - Downloads a particular file from the provider. Returns an object with a single property ",(0,i.kt)("inlineCode",{parentName:"li"},"{ stream }")," - a ",(0,i.kt)("a",{parentName:"li",href:"https://nodejs.org/api/stream.html#stream_class_stream_readable"},(0,i.kt)("inlineCode",{parentName:"a"},"stream.Readable")),", which will be read from and uploaded to the destination. To prevent memory leaks, make sure you release your stream if you reject this method with an error.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"token")," - authorization token (retrieved from oauth process) to send along with your request."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"id")," - ID of the file being downloaded."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"query")," - expressjs query params object received by the server (in case some data you need in there)."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"async size ({ token, id, query })")," - Returns the byte size of the file that needs to be downloaded as a ",(0,i.kt)("inlineCode",{parentName:"li"},"Number"),". If the size of the object is not known, ",(0,i.kt)("inlineCode",{parentName:"li"},"null")," may be returned.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"token")," - authorization token (retrieved from oauth process) to send along with your request."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"id")," - ID of the file being downloaded."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"query")," - expressjs query params object received by the server (in case some data you need in there).")))),(0,i.kt)("p",null,"The class must also have:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A unique ",(0,i.kt)("inlineCode",{parentName:"li"},"authProvider")," string property - a lowercased value which typically indicates the name of the provider (e.g \u201cdropbox\u201d)."),(0,i.kt)("li",{parentName:"ul"},"A ",(0,i.kt)("inlineCode",{parentName:"li"},"static")," property ",(0,i.kt)("inlineCode",{parentName:"li"},"static version = 2"),", which is the current version of the Companion Provider API.")),(0,i.kt)("p",null,"See also ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/transloadit/uppy/blob/main/examples/custom-provider/server"},"example code with a custom provider"),"."),(0,i.kt)("h4",{id:"list-data"},"list data"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  // username or email of the user whose provider account is being accessed\n  "username": "johndoe",\n  // list of files and folders in the directory. An item is considered a folder\n  //  if it mainly exists as a collection to contain sub-items\n  "items": [\n    {\n      // boolean value of whether or NOT it\'s a folder\n      "isFolder": false,\n      // icon image URL\n      "icon": "https://random-api.url.com/fileicon.jpg",\n      // name of the item\n      "name": "myfile.jpg",\n      // the mime type of the item. Only relevant if the item is NOT a folder\n      "mimeType": "image/jpg",\n      // the id (in string) of the item\n      "id": "uniqueitemid",\n      // thumbnail image URL. Only relevant if the item is NOT a folder\n      "thumbnail": "https://random-api.url.com/filethumbnail.jpg",\n      // for folders this is typically the value that will be passed as "directory" in the list(...) method.\n      // For files, this is the value that will be passed as id in the download(...) method.\n      "requestPath": "file-or-folder-requestpath",\n      // datetime string (in ISO 8601 format) of when this item was last modified\n      "modifiedDate": "2020-06-29T19:59:58Z",\n      // the size in bytes of the item. Only relevant if the item is NOT a folder\n      "size": 278940,\n      "custom": {\n        // an object that may contain some more custom fields that you may need to send to the client. Only add this object if you have a need for it.\n        "customData1": "the value",\n        "customData2": "the value"\n      }\n      // more items here\n    }\n  ],\n  // if the "items" list is paginated, this is the request path needed to fetch the next page.\n  "nextPagePath": "directory-name?cursor=cursor-to-next-page"\n}\n')),(0,i.kt)("h3",{id:"how-to-run-companion-locally"},"How to run Companion locally?"),(0,i.kt)("p",null,"1","."," To set up Companion for local development, please clone the Uppy repo and install, like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/transloadit/uppy\ncd uppy\nyarn install\n")),(0,i.kt)("p",null,"2","."," Configure your environment variables by copying the ",(0,i.kt)("inlineCode",{parentName:"p"},"env.example.sh")," file to ",(0,i.kt)("inlineCode",{parentName:"p"},"env.sh")," and edit it to its correct values."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"cp env.example.sh env.sh\n$EDITOR env.sh\n")),(0,i.kt)("p",null,"3","."," To start the server, run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"yarn run start:companion\n")),(0,i.kt)("p",null,"This would get the Companion instance running on ",(0,i.kt)("inlineCode",{parentName:"p"},"http://localhost:3020"),". It uses ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/remy/nodemon"},"nodemon")," so it will automatically restart when files are changed."))}u.isMDXComponent=!0}}]);